(()=>{"use strict";const t="0123456789ABCDEF";function e(t){return new Uint8Array(t)}function r(...t){console.log(...t)}function n(e,r){r||(r=e<256?2:4);let n="";for(let a=0;a<r;a++)n=t[15&e]+n,e>>=4;return n}const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function o(t){let e,r,n,o,s,c,i,l,d=0,f=0;const u=[];if(t){do{o=a.indexOf(t.charAt(d++)),s=a.indexOf(t.charAt(d++)),c=a.indexOf(t.charAt(d++)),i=a.indexOf(t.charAt(d++)),l=o<<18|s<<12|c<<6|i,e=l>>16&255,r=l>>8&255,n=255&l,u[f++]=e,64!==c&&(u[f++]=r),64!==i&&(u[f++]=n)}while(d<t.length);return new Uint8Array(u)}}const s="nibble",c="bitstream",i=["2mg","d13","do","dsk","po","nib"],l=[0,7,14,6,13,5,12,4,11,3,10,2,9,1,8,15],d=[0,8,1,9,2,10,3,11,4,12,5,13,6,14,7,15],f=[0,10,7,4,1,11,8,5,2,12,9,6,3],u=[171,173,174,175,181,182,183,186,187,189,190,191,214,215,218,219,221,222,223,234,235,237,238,239,245,246,247,250,251,253,254,255],h=[150,151,154,155,157,158,159,166,167,171,172,173,174,175,178,179,180,181,182,183,185,186,187,188,189,190,191,203,205,206,207,211,214,215,217,218,219,220,221,222,223,229,230,231,233,234,235,236,237,238,239,242,243,244,245,246,247,249,250,251,252,253,254,255];function E(t){let e=170&t,r=85&t;return e>>=1,e|=170,r|=170,[e,r]}function w(t,e,r,n){let a,o=[];a=0===r?128:0===e?40:38;for(let t=0;t<a;t++)o.push(255);const s=t^e^r;o=o.concat([213,170,150]),o=o.concat(E(t)),o=o.concat(E(e)),o=o.concat(E(r)),o=o.concat(E(s)),o=o.concat([222,170,235]);for(let t=0;t<5;t++)o.push(255);o=o.concat([213,170,173]);const c=[];for(let t=0;t<342;t++)c[t]=0;let i=85;for(let t=257;t>=0;t--){let e=n[t%256],r=c[0+i];r=r<<1|1&e,e>>=1,r=r<<1|1&e,e>>=1,c[86+t]=e,c[0+i]=r,--i<0&&(i=85)}let l=0;for(let t=0;t<342;t++){const e=c[t];o.push(h[l^e]),l=e}return o.push(h[l]),o=o.concat([222,170,235]),o.push(255),o}function g(t,e,r,n){let a,o=[];a=0===r?128:0===e?40:38;for(let t=0;t<a;t++)o.push(255);const s=t^e^r;o=o.concat([213,170,181]),o=o.concat(E(t)),o=o.concat(E(e)),o=o.concat(E(r)),o=o.concat(E(s)),o=o.concat([222,170,235]);for(let t=0;t<5;t++)o.push(255);o=o.concat([213,170,173]);const c=[];let i=0;for(let t=50;t>=0;t--){const e=n[i]>>3,r=7&n[i];i++;const a=n[i]>>3,o=7&n[i];i++;const s=n[i]>>3,l=7&n[i];i++;const d=n[i]>>3,f=7&n[i];i++;const u=n[i]>>3,h=7&n[i];i++,c[t+0]=e,c[t+51]=a,c[t+102]=s,c[t+153]=d,c[t+204]=u,c[t+256]=r<<2|(4&f)>>1|(4&h)>>2,c[t+307]=o<<2|2&f|(2&h)>>1,c[t+358]=l<<2|(1&f)<<1|1&h}c[255]=n[i]>>3,c[409]=7&n[i];let l=0;for(let t=409;t>=256;t--){const e=c[t];o.push(u[l^e]),l=e}for(let t=0;t<256;t++){const e=c[t];o.push(u[l^e]),l=e}return o.push(u[l]),o=o.concat([222,170,235]),o.push(255),o}var A;!function(t){t[t.START_OF_FIELD_MARKER_FIRST_NIBBLE=0]="START_OF_FIELD_MARKER_FIRST_NIBBLE",t[t.START_OF_FIELD_MARKER_SECOND_NIBBLE=1]="START_OF_FIELD_MARKER_SECOND_NIBBLE",t[t.FIELD_TYPE_MARKER=2]="FIELD_TYPE_MARKER",t[t.ADDRESS_FIELD=3]="ADDRESS_FIELD",t[t.ADDRESS_FIELD_13=4]="ADDRESS_FIELD_13",t[t.DATA_FIELD_6AND2=5]="DATA_FIELD_6AND2",t[t.DATA_FIELD_5AND3=6]="DATA_FIELD_5AND3"}(A||(A={}));class m extends Error{constructor(t,e,r){super(`Error finding track ${t} (${toHex(t)}), sector ${e} (${toHex(e)}): `+(r instanceof Error?`${r.message}`:`${String(r)}`))}}class D extends Error{constructor(t,e){super(`Expected: ${toHex(t)}, received: ${toHex(e)}`)}}class b extends Error{constructor(t,e,r){super(`Error reading track ${t} (${toHex(t)}), sector ${e} (${toHex(e)}): `+(r instanceof Error?`${r.message}`:`${String(r)}`))}}function k(t,e){let r=0,n=!0;for(;e<t.length&&(t[e]?(r=r<<1|1,n=!1):n||(r<<=1),!(128&r));)e+=1;return{nibble:r,offset:e}}function O(t){const{data:r,name:n,side:a,rawData:o,volume:c,readOnly:i}=t,d={format:"dsk",encoding:s,metadata:{name:n,side:a},volume:c,readOnly:i,tracks:[]};for(let t=0;t<35;t++){let n=[];for(let e=0;e<16;e++){const a=l[e];let s;if(o){const e=256*(16*t+a);s=new Uint8Array(o.slice(e,e+256))}else{if(!r)throw new Error("Requires data or rawData");s=new Uint8Array(r[t][a])}n=n.concat(w(c,t,e,s))}d.tracks[t]=e(n)}return d}function y(t){const{data:e,name:r,side:n,rawData:a,volume:o,readOnly:c}=t,i={format:"nib",encoding:s,metadata:{name:r,side:n},volume:o||254,readOnly:c||!1,tracks:[]};for(let t=0;t<35;t++){let r;if(a){const e=6656*t;r=new Uint8Array(a.slice(e,e+6656))}else{if(!e)throw new Error("Requires data or rawData");r=e[t][0]}i.tracks[t]=r}return i}function p(t){const{data:r,name:n,side:a,rawData:o,volume:c,readOnly:i}=t,l={format:"po",encoding:s,metadata:{name:n,side:a},volume:c||254,tracks:[],readOnly:i||!1};for(let t=0;t<35;t++){let n=[];for(let e=0;e<16;e++){const a=d[e];let s;if(o){const e=256*(16*t+a);s=new Uint8Array(o.slice(e,e+256))}else{if(!r)throw new Error("Requires data or rawData");s=r[t][a]}n=n.concat(w(c,t,e,s))}l.tracks[t]=e(n)}return l}const T={SIGNATURE:0,CREATOR:4,HEADER_LENGTH:8,VERSION:10,FORMAT:12,FLAGS:16,BLOCKS:20,DATA_OFFSET:24,DATA_LENGTH:28,COMMENT:32,COMMENT_LENGTH:36,CREATOR_DATA:40,CREATOR_DATA_LENGTH:44,PADDING:48},_={READ_ONLY:2147483648,VOLUME_VALID:256,VOLUME_MASK:255};var R;!function(t){t[t.DOS=0]="DOS",t[t.ProDOS=1]="ProDOS",t[t.NIB=2]="NIB"}(R||(R={}));const S=0,L=12,U=828002135,I=844779351,N=168626943;function v(t,e,r){const n=new Uint8Array(t.buffer.slice(t.byteOffset+e,t.byteOffset+r));return String.fromCharCode(...n)}class ${constructor(t){this.sides=0,this.bootSector=0,this.bitTiming=0,this.compatibleHardware=0,this.requiredRAM=0,this.largestTrack=0,this.version=t.getUint8(0),this.diskType=t.getUint8(1),this.writeProtected=t.getUint8(2),this.synchronized=t.getUint8(3),this.cleaned=t.getUint8(4),this.creator=v(t,5,37),this.version>1&&(this.sides=t.getUint8(37),this.bootSector=t.getUint8(38),this.bitTiming=t.getUint8(39),this.compatibleHardware=t.getUint16(40,!0),this.requiredRAM=t.getUint16(42,!0),this.largestTrack=t.getUint16(44,!0))}}class M{constructor(t){this.trackMap=[];for(let e=0;e<160;e++)this.trackMap.push(t.getUint8(e))}}class F{}class C extends F{constructor(t){super(),this.rawTracks=[],this.tracks=[];for(let e=0,r=0;r<t.byteLength;r+=6656,e++){let n=[];const a=[],o=t.buffer.slice(t.byteOffset+r,t.byteOffset+r+6656),s=new Uint8Array(o),c=new DataView(o).getUint16(6648,!0);for(let t=0;t<c;t++){const e=t>>3,r=7-(7&t);a[t]=s[e]>>r&1?1:0}n=[];let i=0;for(;i<a.length;){const t=k(a,i);if(!t.nibble)break;n.push(t.nibble),i=t.offset+1}this.tracks[e]=new Uint8Array(n),this.rawTracks[e]=new Uint8Array(a)}}}class x extends F{constructor(t){let e;for(super(),this.trks=[],e=0;e<160;e++){const r=t.getUint16(8*e,!0),n=t.getUint16(8*e+2,!0),a=t.getUint32(8*e+4,!0);if(0===a)break;this.trks.push({startBlock:r,blockCount:n,bitCount:a})}this.tracks=[],this.rawTracks=[];const r=t.buffer;for(e=0;e<this.trks.length;e++){const t=this.trks[e];let n=[];const a=[],o=512*t.startBlock,s=o+512*t.blockCount,c=r.slice(o,s),i=new Uint8Array(c);for(let e=0;e<t.bitCount;e++){const t=e>>3,r=7-(7&e);a[e]=i[t]>>r&1?1:0}n=[];let l=0;for(;l<a.length;){const t=k(a,l);if(!t.nibble)break;n.push(t.nibble),l=t.offset+1}this.tracks[e]=new Uint8Array(n),this.rawTracks[e]=new Uint8Array(a)}}}class H{constructor(t){const e=v(t,0,t.byteLength).split("\n");this.values=e.reduce((function(t,e){const r=e.split("\t");return t[r[0]]=r[1],t}),{})}}function B(t,e){let a=null;switch(t){case"2mg":a=function(t){let e,{rawData:r}=t;if(!r)throw new Error("Requires rawData");const{bytes:n,format:a,offset:o,readOnly:s,volume:c}=function(t){const e=new DataView(t),r=new TextDecoder("ascii"),n=r.decode(t.slice(T.SIGNATURE,T.SIGNATURE+4));if("2IMG"!==n)throw new Error(`Unrecognized 2mg signature: ${n}`);const a=r.decode(t.slice(T.CREATOR,T.CREATOR+4)),o=e.getInt16(T.HEADER_LENGTH,!0);if(64!==o)throw new Error(`2mg header length is incorrect ${o} !== 64`);const s=e.getInt32(T.FORMAT,!0),c=e.getInt32(T.FLAGS,!0),i=e.getInt32(T.BLOCKS,!0),l=e.getInt32(T.DATA_OFFSET,!0),d=e.getInt32(T.DATA_LENGTH,!0),f=e.getInt32(T.COMMENT,!0),u=e.getInt32(T.COMMENT_LENGTH,!0),h=e.getInt32(T.CREATOR_DATA,!0),E=e.getInt32(T.CREATOR_DATA_LENGTH,!0);if(s===R.ProDOS&&512*i!==d)throw new Error(`2mg blocks does not match disk data length: ${i} * 512 !== ${d}`);if(l<o)throw new Error(`2mg data offset is less than header length: ${l} < ${o}`);if(l+d>e.byteLength)throw new Error(`2mg data extends beyond disk image: ${l} + ${d} > ${e.byteLength}`);const w=l+d;if(f&&f<w)throw new Error(`2mg comment is before the end of the disk data: ${f} < ${l} + ${d}`);const g=f?f+u:w;if(g>e.byteLength)throw new Error(`2mg comment extends beyond disk image: ${g} > ${e.byteLength}`);if(h&&h<g)throw new Error(`2mg creator data is before the end of the comment: ${h} < ${g}`);const A=h?h+E:g;if(A>e.byteLength)throw new Error(`2mg creator data extends beyond disk image: ${A} > ${e.byteLength}`);const m={};f&&(m.comment=new TextDecoder("utf-8").decode(new Uint8Array(t,f,u))),h&&(m.creatorData=new Uint8Array(t,h,E));const D=0!=(c&_.READ_ONLY);let b=s===R.DOS?254:0;return c&_.VOLUME_VALID&&(b=c&_.VOLUME_MASK),Object.assign({bytes:d,creator:a,format:s,offset:l,readOnly:D,volume:b},m)}(r);switch(r=r.slice(o,o+n),t=Object.assign(Object.assign({},t),{rawData:r,readOnly:s,volume:c}),a){case R.ProDOS:e=p(t);break;case R.NIB:e=y(t);break;case R.DOS:default:e=O(t)}return e}(e);break;case"d13":a=function(t){const{data:e,name:r,side:n,rawData:a,volume:o,readOnly:c}=t,i={format:"d13",encoding:s,metadata:{name:r,side:n},volume:o,readOnly:c,tracks:[]};if(!e&&!a)throw new Error("data or rawData required");for(let t=0;t<35;t++){let r=[];for(let n=0;n<13;n++){const s=f[n];let c;if(a){const e=256*(13*t+s);c=new Uint8Array(a.slice(e,e+256))}else{if(!e)throw new Error("Requires data or rawData");c=e[t][s]}r=r.concat(g(o,t,s,c))}i.tracks.push(new Uint8Array(r))}return i}(e);break;case"do":case"dsk":a=O(e);break;case"nib":a=y(e);break;case"po":a=p(e);break;case"woz":a=function(t){const{rawData:e}=t;if(!e)throw new Error("Requires rawData");const a=new DataView(e,0);let o,s=0;const i={};function l(){if(s>=a.byteLength)return null;const t=a.getUint32(s,!0),e=a.getUint32(s+4,!0),r=new DataView(a.buffer,s+8,e);return s+=e+8,{type:t,size:e,data:r}}if(function(){switch(a.getUint32(S+0,!0)){case U:o=1;break;case I:o=2;break;default:return!1}return a.getUint32(S+4,!0)===N}()){s=L;let t=l();for(;t;){switch(t.type){case 1330007625:i.info=new $(t.data);break;case 1346456916:i.tmap=new M(t.data);break;case 1397445204:i.trks=1===o?new C(t.data):new x(t.data);break;case 1096041805:i.meta=new H(t.data);break;case 1414091351:break;default:r("Unsupported chunk",n(t.type,8))}t=l()}}else r("Invalid woz header");const{meta:d,tmap:f,trks:u,info:h}=i;return{encoding:c,format:"woz",trackMap:(null==f?void 0:f.trackMap)||[],rawTracks:(null==u?void 0:u.rawTracks)||[],readOnly:!0,metadata:{name:(null==d?void 0:d.values.title)||t.name,side:(null==d?void 0:d.values.side_name)||(null==d?void 0:d.values.side)},info:h}}(e)}return a}r("Worker loaded"),addEventListener("message",(t=>{r("Worker started",t.type);const n=t.data,{driveNo:a}=n.payload;let c=null;switch(n.type){case"PROCESS_BINARY":{const{fmt:t,options:e}=n.payload;c=B(t,e)}break;case"PROCESS_JSON_DISK":{const{jsonDisk:t}=n.payload;c=function(t){const e=t.type,r=t.readOnly,n=t.name,a=t.disk;if(s=e,i.includes(s)){let s;if("base64"===t.encoding){s=[];for(let e=0;e<t.data.length;e++)if(s[e]=[],"nib"===t.type)s[e][0]=o(t.data[e]);else for(let r=0;r<t.data[e].length;r++)s[e][r]=o(t.data[e][r])}else s=t.data;return B(e,{volume:t.volume||254,readOnly:r,name:n,side:a,data:s})}return null;var s}(t)}break;case"PROCESS_JSON":{const{json:t}=n.payload;c=function(t){const r=[],n=JSON.parse(t),a=n.volume||254,c=n.readOnly||!1;for(let t=0;t<n.data.length;t++){let s=[];for(let e=0;e<n.data[t].length;e++){const r="po"===n.type?d[e]:l[e],c=o(n.data[t][r]);s=s.concat(w(a,t,e,c))}r[t]=e(s)}if(f=n.type,!i.includes(f))throw new Error(`JSON disks of type ${n.type} are not supported`);var f;return{volume:a,format:n.type,encoding:s,metadata:{name:n.name},tracks:r,readOnly:c}}(t)}}const f={type:"DISK_PROCESSED",payload:{driveNo:a,disk:c}};self.postMessage(f),r("Worker complete",t.type)}))})();
//# sourceMappingURL=format_worker.bundle.js.map